{% extends 'index.html' %}
{% block content %}
<div class="page-header">
    <h2><i class="fas fa-pills"></i> Medicine Management</h2>
    <div class="header-actions">
        <button class="btn" data-toggle="modal" data-target="#addMedicineModal">
            <i class="fas fa-plus"></i> Add New Medicine
        </button>
    </div>
</div>

<div class="search-filter mb-3">
    <input type="text" id="medicineSearch" placeholder="Search medicines..." class="form-control">
    <select id="filterStock" class="form-control">
        <option value="all">All Stock</option>
        <option value="low">Low Stock (<10)</option>
        <option value="out">Out of Stock</option>
    </select>
</div>

<div class="table-responsive">
    <table class="data-table">
        <thead>
            <tr>
                <th>Medicine Name</th>
                <th>Batch</th>
                <th>Expiry</th>
                <th>Stock</th>
                <th>MRP</th>
                <th>Rate</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for med in medicines %}
            <tr class="{% if med.quantity < 5 %}table-danger{% elif med.quantity < 20 %}table-warning{% endif %}">
                <td>
                    <strong>{{ med.name }}</strong>
                    {% if med.generic_name %}<br><small>{{ med.generic_name }}</small>{% endif %}
                </td>
                <td>{{ med.batch or 'N/A' }}</td>
                <td>{{ med.expiry or 'N/A' }}</td>
                <td>
                    <div class="stock-indicator">
                        <div class="progress">
                            {% set percent = med.quantity if med.quantity <= 100 else 100 %}
                            <div class="progress-bar {% if med.quantity < 5 %}bg-danger{% elif med.quantity < 20 %}bg-warning{% else %}bg-success{% endif %}" 
                                 role="progressbar" style="width: {{ percent }}%" 
                                 aria-valuenow="{{ med.quantity }}" aria-valuemin="0" aria-valuemax="100">
                            </div>
                        </div>
                        <span>{{ med.quantity }} units</span>
                    </div>
                </td>
                <td>{{ med.mrp|currency }}</td>
                <td>{{ med.rate|currency }}</td>
                <td>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-outline" data-toggle="modal" data-target="#editMedicineModal{{ med.id }}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <a href="{{ url_for('delete_medicine', id=med.id) }}" class="btn btn-sm btn-outline-danger">
                            <i class="fas fa-trash"></i>
                        </a>
                    </div>
                </td>
            </tr>
            
            <!-- Edit Medicine Modal -->
            <div class="modal fade" id="editMedicineModal{{ med.id }}" tabindex="-1" role="dialog">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Edit Medicine</h5>
                            <button type="button" class="close" data-dismiss="modal">
                                <span>&times;</span>
                            </button>
                        </div>
                        <form method="POST" action="{{ url_for('edit_medicine', id=med.id) }}">
                            <div class="modal-body">
                                <div class="form-group">
                                    <label>Medicine Name</label>
                                    <input type="text" name="name" value="{{ med.name }}" class="form-control" required>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label>Batch Number</label>
                                            <input type="text" name="batch" value="{{ med.batch }}" class="form-control">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label>Expiry Date</label>
                                            <input type="text" name="expiry" value="{{ med.expiry }}" class="form-control" placeholder="MM/YYYY">
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label>Quantity</label>
                                            <input type="number" name="quantity" value="{{ med.quantity }}" class="form-control" required>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label>MRP</label>
                                            <input type="number" step="0.01" name="mrp" value="{{ med.mrp }}" class="form-control" required>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label>Purchase Rate</label>
                                            <input type="number" step="0.01" name="rate" value="{{ med.rate }}" class="form-control" required>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                                <button type="submit" class="btn btn-primary">Save Changes</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Add Medicine Modal -->
<div class="modal fade" id="addMedicineModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Medicine</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <form method="POST" action="{{ url_for('medicine') }}">
                <div class="modal-body">
                    <div class="form-group">
                        <label>Medicine Name</label>
                        <input type="text" name="name" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>Generic Name (Optional)</label>
                        <input type="text" name="generic_name" class="form-control">
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Batch Number</label>
                                <input type="text" name="batch" class="form-control">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Expiry Date</label>
                                <input type="text" name="expiry" class="form-control" placeholder="MM/YYYY">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Quantity</label>
                                <input type="number" name="quantity" class="form-control" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>MRP</label>
                                <input type="number" step="0.01" name="mrp" class="form-control" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Purchase Rate</label>
                                <input type="number" step="0.01" name="rate" class="form-control" required>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Add Medicine</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}