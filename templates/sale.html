{% extends 'index.html' %}
{% block content %}
<div class="page-header">
    <h2><i class="fas fa-cash-register"></i> New Sale</h2>
    <div class="header-actions">
        <a href="{{ url_for('sales') }}" class="btn btn-outline">
            <i class="fas fa-list"></i> View All Sales
        </a>
    </div>
</div>

<form method="POST" id="saleForm">
    <div class="row">
        <div class="col-md-6">
            <div class="form-group">
                <label>Customer Name</label>
                <input type="text" name="customer_name" class="form-control" required>
            </div>
        </div>
        <div class="col-md-6">
            <div class="form-group">
                <label>Contact Number</label>
                <input type="text" name="contact" class="form-control">
            </div>
        </div>
    </div>
    
    <div class="form-group">
        <label>Doctor Name (Optional)</label>
        <input type="text" name="doctor_name" class="form-control">
    </div>
    
    <div class="card mb-4">
        <div class="card-header">
            <h4><i class="fas fa-pills"></i> Select Medicines</h4>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table" id="medicineSelection">
                    <thead>
                        <tr>
                            <th>Select</th>
                            <th>Medicine</th>
                            <th>Batch</th>
                            <th>Expiry</th>
                            <th>Stock</th>
                            <th>MRP</th>
                            <th>Qty</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for med in medicines %}
                        <tr class="medicine-row">
                            <td>
                                <input type="checkbox" name="medicine_id" value="{{ med.id }}" 
                                       class="medicine-check" data-medicine-id="{{ med.id }}">
                            </td>
                            <td>{{ med.name }}</td>
                            <td>{{ med.batch or 'N/A' }}</td>
                            <td>{{ med.expiry or 'N/A' }}</td>
                            <td>{{ med.quantity }}</td>
                            <td class="price">{{ med.mrp }}</td>
                            <td>
                                <input type="number" name="quantity" min="0" max="{{ med.quantity }}" 
                                       value="0" class="form-control qty-input" disabled>
                            </td>
                            <td class="total">0.00</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-4">
            <div class="form-group">
                <label>Discount (%)</label>
                <input type="number" step="0.01" name="discount" id="discount" 
                       value="0" class="form-control" min="0" max="100">
            </div>
        </div>
        <div class="col-md-4">
            <div class="form-group">
                <label>Tax (%)</label>
                <input type="number" step="0.01" name="tax" id="tax" 
                       value="0" class="form-control" min="0">
            </div>
        </div>
        <div class="col-md-4">
            <div class="form-group">
                <label>Payment Method</label>
                <select name="payment_method" class="form-control">
                    <option value="cash">Cash</option>
                    <option value="card">Card</option>
                    <option value="upi">UPI</option>
                    <option value="insurance">Insurance</option>
                </select>
            </div>
        </div>
    </div>
    
    <div class="card mb-4">
        <div class="card-header">
            <h4><i class="fas fa-receipt"></i> Bill Summary</h4>
        </div>
        <div class="card-body">
            <div class="bill-summary">
                <div class="bill-row">
                    <span>Subtotal:</span>
                    <span id="subtotal">0.00</span>
                </div>
                <div class="bill-row">
                    <span>Discount (<span id="discount-percent">0</span>%):</span>
                    <span id="discount-amount">0.00</span>
                </div>
                <div class="bill-row">
                    <span>Tax (<span id="tax-percent">0</span>%):</span>
                    <span id="tax-amount">0.00</span>
                </div>
                <div class="bill-row grand-total">
                    <span>Grand Total:</span>
                    <span id="grand-total">0.00</span>
                </div>
            </div>
        </div>
    </div>
    
    <div class="form-actions">
        <button type="button" class="btn btn-secondary">
            <i class="fas fa-times"></i> Cancel
        </button>
        <button type="submit" class="btn btn-primary">
            <i class="fas fa-check"></i> Complete Sale
        </button>
    </div>
</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Enable quantity input when medicine is selected
    document.querySelectorAll('.medicine-check').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const medicineId = this.dataset.medicineId;
            const qtyInput = document.querySelector(`input[name="quantity"][data-medicine-id="${medicineId}"]`);
            qtyInput.disabled = !this.checked;
            if (!this.checked) {
                qtyInput.value = 0;
            }
            calculateTotals();
        });
    });
    
    // Update discount and tax percentages
    document.getElementById('discount').addEventListener('input', function() {
        document.getElementById('discount-percent').textContent = this.value;
        calculateTotals();
    });
    
    document.getElementById('tax').addEventListener('input', function() {
        document.getElementById('tax-percent').textContent = this.value;
        calculateTotals();
    });
    
    // Calculate totals function
    function calculateTotals() {
        let subtotal = 0;
        
        document.querySelectorAll('.medicine-row').forEach(row => {
            const checkbox = row.querySelector('.medicine-check');
            const qtyInput = row.querySelector('.qty-input');
            
            if (checkbox.checked) {
                const price = parseFloat(row.querySelector('.price').textContent);
                const quantity = parseFloat(qtyInput.value) || 0;
                const total = price * quantity;
                row.querySelector('.total').textContent = total.toFixed(2);
                subtotal += total;
            } else {
                row.querySelector('.total').textContent = '0.00';
            }
        });
        
        document.getElementById('subtotal').textContent = subtotal.toFixed(2);
        
        const discount = parseFloat(document.getElementById('discount').value) || 0;
        const tax = parseFloat(document.getElementById('tax').value) || 0;
        
        const discountAmount = subtotal * (discount / 100);
        const taxAmount = subtotal * (tax / 100);
        const grandTotal = subtotal - discountAmount + taxAmount;
        
        document.getElementById('discount-amount').textContent = discountAmount.toFixed(2);
        document.getElementById('tax-amount').textContent = taxAmount.toFixed(2);
        document.getElementById('grand-total').textContent = grandTotal.toFixed(2);
    }
    
    // Initial calculation
    calculateTotals();
});
</script>
{% endblock %}